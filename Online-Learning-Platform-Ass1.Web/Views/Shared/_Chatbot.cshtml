<div id="chatbot-widget" class="position-fixed bottom-0 end-0 p-4" style="z-index: 1050;">
    <!-- Toggle Button -->
    <button id="chatbot-toggle" class="btn btn-primary rounded-circle shadow-lg p-3 d-flex align-items-center justify-content-center"
            style="width: 60px; height: 60px; transition: transform 0.2s;">
        <i class="bi bi-chat-dots-fill fs-3"></i>
    </button>

    <!-- Chat Window -->
    <div id="chatbot-window" class="card shadow-lg mt-3 d-none" style="width: 350px; height: 500px; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column;">
        
        <!-- Header -->
        <!-- Header -->
        <div class="card-header bg-dark text-white d-flex align-items-center justify-content-between py-2">
            <h5 class="mb-0 fs-6 text-truncate pe-2" id="chatbot-title" style="max-width: 180px;"><i class="bi bi-robot me-2"></i>Course Advisor</h5>
            <div class="d-flex align-items-center flex-shrink-0">
                <!-- New Chat -->
                <button id="chatbot-new-btn" class="btn btn-sm btn-link text-white p-0 me-3" title="Cuộc trò chuyện mới">
                    <i class="bi bi-plus-lg fs-5"></i>
                </button>
                <!-- History -->
                <button id="chatbot-menu-btn" class="btn btn-sm btn-link text-white p-0 me-3" title="Lịch sử">
                    <i class="bi bi-clock-history fs-5"></i>
                </button>
                <!-- Options (...) -->
                <div class="dropdown me-3">
                    <button class="btn btn-sm btn-link text-white p-0" type="button" id="chatbot-options-btn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots fs-5"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatbot-options-btn">
                        <li><button class="dropdown-item text-danger" id="chatbot-clear-all"><i class="bi bi-trash me-2"></i>Xóa tất cả</button></li>
                    </ul>
                </div>
                <!-- Close -->
                <button id="chatbot-close" class="btn btn-sm btn-link text-white p-0" title="Đóng">
                    <i class="bi bi-x-lg fs-5"></i>
                </button>
            </div>
        </div>
        
        <!-- Body Container (Stacking Context for Views) -->
        <div class="position-relative flex-grow-1 bg-light" style="overflow: hidden;">
            
            <!-- Chat Messages View -->
            <div id="chatbot-view-messages" class="w-100 h-100 d-flex flex-column">
                <div id="chatbot-messages" class="flex-grow-1 overflow-auto p-3">
                    <!-- Messages will be injected here -->
                </div>
            </div>

            <!-- Sessions List View (Overlay) -->
            <div id="chatbot-view-sessions" class="w-100 h-100 position-absolute top-0 start-0 bg-white d-none overflow-auto p-0" style="z-index: 10;">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                    <h6 class="mb-0 fw-bold">Lịch sử trò chuyện</h6>
                    <button id="chatbot-back-btn" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Quay lại
                    </button>
                </div>
                <div id="chatbot-sessions-list" class="list-group list-group-flush">
                    <!-- Sessions will be injected here -->
                </div>
            </div>

        </div>

        <!-- Footer (Input) -->
        <div id="chatbot-footer" class="card-footer bg-white border-top-0 p-2">
            <div class="input-group">
                <input type="text" id="chatbot-input" class="form-control border-0 bg-light" placeholder="Nhập câu hỏi..." style="border-radius: 20px 0 0 20px;">
                <button id="chatbot-send" class="btn btn-primary" style="border-radius: 0 20px 20px 0;">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // UI Elements
        const widget = document.getElementById('chatbot-widget');
        const toggleBtn = document.getElementById('chatbot-toggle');
        const chatWindow = document.getElementById('chatbot-window');
        const closeBtn = document.getElementById('chatbot-close');
        
        const menuBtn = document.getElementById('chatbot-menu-btn');
        const newChatBtn = document.getElementById('chatbot-new-btn');
        const clearAllBtn = document.getElementById('chatbot-clear-all');
        const backBtn = document.getElementById('chatbot-back-btn');
        const sendBtn = document.getElementById('chatbot-send');
        const inputField = document.getElementById('chatbot-input');
        
        const viewMessages = document.getElementById('chatbot-view-messages');
        const viewSessions = document.getElementById('chatbot-view-sessions');
        const messagesContainer = document.getElementById('chatbot-messages');
        const sessionsListContainer = document.getElementById('chatbot-sessions-list');
        const chatTitle = document.getElementById('chatbot-title');

        // State
        let sessions = [];
        let currentSessionId = null;

        // Constants
        const STORAGE_KEY = 'chatSessions_v2'; 
        // Migrate old data if necessary or just start fresh with v2 key to avoid conflicts
        
        // --- Initialization ---
        init();

        function init() {
            loadSessions();
            if (sessions.length === 0) {
                createNewSession();
            } else {
                // Determine which session to open. Currently default to the most recent one (first in list usually, or sort by timestamp)
                // Let's sort sessions by timestamp desc first just to be sure
                sessions.sort((a, b) => b.timestamp - a.timestamp);
                openSession(sessions[0].id);
            }
        }

        // --- Core Logic ---

        function loadSessions() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    sessions = JSON.parse(data);
                }
            } catch (e) {
                console.error("Failed to load sessions", e);
                sessions = [];
            }
        }

        function saveSessions() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
        }

        function createNewSession() {
            const newId = 'session_' + Date.now() + Math.random().toString(36).substr(2, 9);
            const newSession = {
                id: newId,
                title: 'Cuộc trò chuyện mới',
                timestamp: Date.now(),
                messages: [] // Empty initially
            };
            sessions.unshift(newSession); // Add to top
            saveSessions();
            openSession(newId);
            showMessagesView();
        }

        function clearAllSessions() {
            if (!confirm('Bạn có chắc muốn xóa TẤT CẢ lịch sử chat không? Hành động này không thể hoàn tác.')) return;
            sessions = [];
            saveSessions();
            createNewSession();
        }

        function openSession(sessionId) {
            currentSessionId = sessionId;
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            // Render Messages
            messagesContainer.innerHTML = ''; // Clear current
            
            // Add Welcome Message if empty or just always add distinct welcome UI? 
            // Let's add a welcome UI if it's empty
            if (session.messages.length === 0) {
                addWelcomeMessageUI();
            } else {
                session.messages.forEach(msg => {
                    addMessageToUI(msg.text, msg.sender, false);
                });
            }

            // Scroll to bottom
            scrollToBottom();
            
            // Update Title if needed (optional)
        }

        function deleteSession(sessionId, event) {
            if (event) event.stopPropagation();
            if (!confirm('Bạn có chắc muốn xóa cuộc trò chuyện này?')) return;

            sessions = sessions.filter(s => s.id !== sessionId);
            saveSessions();

            if (sessions.length === 0) {
                createNewSession();
            } else if (currentSessionId === sessionId) {
                openSession(sessions[0].id);
            }
            
            renderSessionsList(); // Re-render list
        }

        function sendMessage() {
            const text = inputField.value.trim();
            if (!text) return;

            // user message
            addMessage(text, 'user');
            inputField.value = '';

            // Update title if it's the first real message
            const session = sessions.find(s => s.id === currentSessionId);
            if (session && session.messages.length === 1) { // just added user msg
                // Generate simple title from first few words
                let newTitle = text.substring(0, 30);
                if (text.length > 30) newTitle += '...';
                session.title = newTitle;
                saveSessions();
            }

            // Loading
            const loadingId = addMessageToUI('Đang suy nghĩ...', 'ai', true);

            // Context preparation
            // Get last 10 messages from CURRENT session
            const contextHistory = session.messages.slice(-10).map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'assistant',
                content: msg.text
            }));

            // API Call
             fetch('/api/Chatbot/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    question: text,
                    history: contextHistory
                })
            })
            .then(res => res.json())
            .then(data => {
                removeMessageUI(loadingId);
                if (data.response) {
                    addMessage(data.response, 'ai');
                } else if (data.error) {
                    addMessage('Lỗi: ' + data.error, 'ai');
                }
            })
            .catch(err => {
                removeMessageUI(loadingId);
                addMessage('Lỗi kết nối.', 'ai');
                console.error(err);
            });
        }

        function addMessage(text, sender) {
            addMessageToUI(text, sender);
            
            const session = sessions.find(s => s.id === currentSessionId);
            if (session) {
                session.messages.push({ text, sender, timestamp: Date.now() });
                // Update session timestamp to move it to top?
                session.timestamp = Date.now();
                // Move this session to index 0?
                // sessions = sessions.filter(s => s.id !== currentSessionId);
                // sessions.unshift(session); 
                // Let's just update timestamp and sort when listing.
                
                saveSessions();
            }
        }

        // --- UI Rendering Helpers ---

        function addWelcomeMessageUI() {
            const html = `
                <div class="d-flex flex-row justify-content-start mb-3">
                    <div class="bg-white p-2 rounded shadow-sm border" style="max-width: 80%;">
                        <small class="text-muted d-block mb-1">AI Advisor</small>
                        <span>Chào bạn! Tôi có thể giúp gì cho bạn hôm nay?</span>
                    </div>
                </div>`;
            messagesContainer.insertAdjacentHTML('beforeend', html);
        }

        function addMessageToUI(text, sender, isLoading = false) {
            const id = 'msg-' + Date.now() + Math.random().toString(36).substr(2, 9);
            const align = sender === 'user' ? 'justify-content-end' : 'justify-content-start';
            const bg = sender === 'user' ? 'bg-primary text-white' : 'bg-white border';
            const label = sender === 'user' ? 'Bạn' : 'AI Advisor';
            const labelContent = sender === 'user' ? label : `<i class="bi bi-robot me-1"></i>${label}`;
            const labelClass = sender === 'user' ? 'text-white-50 text-end' : 'text-muted';

            const html = `
                <div id="${id}" class="d-flex flex-row ${align} mb-3 fade-in">
                    <div class="${bg} p-2 rounded shadow-sm" style="max-width: 85%; font-size: 0.95rem;">
                        <small class="${labelClass} d-block mb-1" style="font-size: 0.75rem;">${labelContent}</small>
                        <span style="white-space: pre-wrap;">${text}</span>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            return id;
        }

        function removeMessageUI(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderSessionsList() {
            sessionsListContainer.innerHTML = '';
            // Sort by valid timestamp
            const sorted = [...sessions].sort((a, b) => b.timestamp - a.timestamp);

            if (sorted.length === 0) {
                sessionsListContainer.innerHTML = '<div class="text-center p-3 text-muted">Chưa có cuộc trò chuyện nào.</div>';
                return;
            }

            sorted.forEach(s => {
                const isActive = s.id === currentSessionId;
                const activeClass = isActive ? 'bg-primary-subtle text-primary fw-medium' : 'bg-white text-dark';
                // Date formatting
                const date = new Date(s.timestamp).toLocaleDateString();
                
                const item = document.createElement('div');
                item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${activeClass}`;
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div class="text-truncate flex-grow-1 pe-2">
                        <div class="text-truncate">${s.title}</div>
                        <small class="text-muted" style="font-size: 0.75rem;">${date}</small>
                    </div>
                    <button class="btn btn-sm btn-link text-danger p-0 z-2 delete-btn" title="Xóa">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                
                // Click to open
                item.addEventListener('click', () => {
                   openSession(s.id); 
                   showMessagesView();
                });

                // Delete button
                const delBtn = item.querySelector('.delete-btn');
                delBtn.addEventListener('click', (e) => deleteSession(s.id, e));

                sessionsListContainer.appendChild(item);
            });
        }

        // --- View Switching ---
        
        function showSessionsView() {
            renderSessionsList();
            viewMessages.classList.add('d-none');
            viewSessions.classList.remove('d-none');
            document.getElementById('chatbot-footer').classList.add('d-none'); // Hide input
        }

        function showMessagesView() {
            viewSessions.classList.add('d-none');
            viewMessages.classList.remove('d-none');
            document.getElementById('chatbot-footer').classList.remove('d-none'); // Show input
            scrollToBottom();
        }

        // --- Event Listeners ---

        toggleBtn.addEventListener('click', () => {
            chatWindow.classList.toggle('d-none');
            toggleBtn.classList.toggle('d-none');
            if (!chatWindow.classList.contains('d-none')) {
                scrollToBottom();
            }
        });

        closeBtn.addEventListener('click', () => {
            chatWindow.classList.add('d-none');
            toggleBtn.classList.remove('d-none');
        });

        menuBtn.addEventListener('click', showSessionsView);
        backBtn.addEventListener('click', showMessagesView);

        newChatBtn.addEventListener('click', () => {
            createNewSession();
        });

        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', clearAllSessions);
        }

        sendBtn.addEventListener('click', sendMessage);
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    });
</script>

<style>
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Custom scrollbar for better look */
    #chatbot-messages::-webkit-scrollbar {
        width: 6px;
    }
    #chatbot-messages::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 3px;
    }
</style>
